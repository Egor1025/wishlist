# NFR_BDD.md — Приёмка ключевых NFR в формате Gherkin

## Feature: p95 задержка API
```
Scenario: p95 <= 300 ms при 30 RPS на базовых GET
  Given развёрнут сервис с тестовыми >= 100 wishes
  And подготовлен скрипт нагрузки на 30 RPS длительностью 2 минуты для GET /wishes и GET /wishes?price<
  When запускается нагрузочный тест
  Then 95-й перцентиль времени ответа <= 300 ms для каждого эндпоинта
```

## Feature: Уязвимости зависимостей
```
Scenario: В CI нет High/Critical уязвимостей
  Given настроен запуск pip-audit в CI
  When выполняется анализ зависимостей
  Then количество уязвимостей уровня High и Critical == 0
  And если ранее были High/Critical, то их возраст <= 7 дней (иначе билд падает)
```

### Feature: Секреты и конфигурация
```
Scenario: Коммиты не содержат секретов; ротация не более 30 дней
  Given активирован gitleaks в pre-commit и CI
  And в репозитории ведётся дата последней ротации секретов
  When выполняется проверка PR
  Then количество находок gitleaks == 0
  And дата последней ротации секретов не более 30 дней
```

### Feature: Маскирование ПДн в API
```
Scenario: Ответы не содержат полные ПДн, маски применены корректно
  Given включён сбор ответов API на выборке из >= 200 запросов
  When выполняется анализ содержимого JSON-полей, где возможны email/телефон
  Then не менее 95% ответов не содержат полные ПДн
  And email соответствует шаблону маски e***@g****.com
  And телефон соответствует шаблону +7***
```

## Негативные сценарии

### Feature: Защита от утечки секретов
```
Scenario: Попытка закоммитить секрет блокируется
  Given в рабочем каталоге присутствует файл с токеном (имитация утечки)
  When разработчик делает commit
  Then pre-commit gitleaks блокирует коммит и выводит отчёт с путём файла
```

### Feature: Контроль маскирования при регрессии
```
Scenario: Полный email в ответе обнаруживается тестом
  Given сервис возвращает полный email в одном из полей ответа
  When запускается тест проверки маски
  Then тест падает с указанием поля и примера значения
```
