# ADR-002: Ограничения и таймауты для исходящих HTTP-запросов
Дата: 2025-10-15
Статус: Accepted

## Context
Некоторые ручки в будущем могут обращаться к внешним API (например, чтобы проверять цены). Отсутствие лимитов и таймаутов может привести к зависанию приложения, перегрузке или DoS. Необходимо стандартизировать клиентскую политику.

Рассматривались варианты:
- Использовать `requests` без ограничений.
- Использовать `httpx` с явным указанием `timeout`, `max_retries`, `max_connections`.
- Использовать внешний прокси с политиками ограничений.

## Decision
Принято решение использовать **httpx.AsyncClient** с глобальными параметрами:
- `timeout=3.0` секунд
- `max_retries=2`
- `max_connections=10`

## Consequences
**Плюсы:**
- Исключаются зависания при недоступности внешних сервисов.
- Контролируемый объём исходящих соединений.
- Легко тестировать отказоустойчивость.

**Минусы:**
- Увеличивается задержка из-за повторов.
- Нужно следить за балансом между таймаутами и производительностью.

## Security impact
Ограничение таймаутов и ретраев предотвращает зависание приложения при атаке DoS и снижает риск утечек ресурсов.

## Rollout plan #22

## Links
- NFR-01 (p95 задержка API), NFR-03 (стабильность)
- F2/R2 (перегрузка сервера)
